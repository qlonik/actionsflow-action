name: Release

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "dist/**"
  workflow_dispatch:
  repository_dispatch:
    types: [new_version_with_actionsflow]

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Checkout Branch
        run: git checkout main
      - name: Configure CI Git User
        run: |
          git config user.name moki-bot
          git config user.email 125534110+moki-bot[bot]@users.noreply.github.com
      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node
      - name: Use Node.js LTS
        uses: actions/setup-node@v3
        with:
          node-version: lts/*
      - name: Generate Token
        uses: tibdex/github-app-token@v1
        id: generate-token
        with:
          app_id: "${{ secrets.BOT_APP_ID }}"
          private_key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"
      - name: Build & Test
        run: |
          npm ci
          npm run build
          npm run test
      - name: Git status
        run: git status
      - name: Fail on unexpected uncommitted files
        run: |
          git diff --quiet HEAD -- :^dist :^package.json :^package-lock.json
      - name: Release
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: npm exec --no -- release-it
